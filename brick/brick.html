<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß± BRICK - View a Brick</title>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body {
            background: #f8fafc;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .brick-card {
            background: white;
            border-radius: 32px;
            padding: 40px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 40px #FF44AA20;
            border: 2px solid #FF44AA;
        }
        .brick-image {
            width: 200px;
            height: 200px;
            border-radius: 20px;
            object-fit: cover;
            margin-bottom: 20px;
            border: 3px solid #FF44AA;
        }
        .brick-cell {
            font-size: 48px;
            color: #FF44AA;
            font-weight: 800;
            margin-bottom: 10px;
        }
        .brick-message {
            font-size: 18px;
            color: #1e293b;
            margin: 20px 0;
            padding: 20px;
            background: #f1f5f9;
            border-radius: 16px;
        }
        .brick-wallet {
            font-family: monospace;
            color: #64748b;
            background: #f8fafc;
            padding: 10px;
            border-radius: 40px;
            margin: 20px 0;
        }
        .back-link {
            display: inline-block;
            margin-top: 20px;
            color: #FF44AA;
            text-decoration: none;
            font-weight: 600;
        }
        .error-emoji { font-size: 48px; margin: 20px 0; }
        .error-message { color: #FF44AA; font-size: 24px; margin: 20px 0; }
        .claim-button {
            display: inline-block;
            background: #FF44AA;
            color: white;
            padding: 15px 30px;
            border-radius: 60px;
            text-decoration: none;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="brick-card" id="brick-card">
        <div id="content">
            <!-- Rempli par JS -->
        </div>
        <a href="canvas.html" class="back-link">‚Üê Back to Canvas</a>
    </div>

    <script>
        const SUPABASE_URL = "https://bmfuvkylkhjcfsiauzvb.supabase.co";
        const SUPABASE_ANON = "sb_publishable_VuzUNoj1NnJk1BWSbVzJjQ_WABRhxDh";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

        const urlParams = new URLSearchParams(window.location.search);
        const cell = urlParams.get('cell');

        async function loadBrick() {
            if (!cell) {
                window.location.href = 'canvas.html';
                return;
            }

            try {
                // Chercher dans Supabase
                const { data, error } = await supabaseClient
                    .from('bricks')
                    .select('*')
                    .eq('cell', cell)
                    .single();

                if (error || !data) {
                    // Brique non trouv√©e
                    document.getElementById('content').innerHTML = `
                        <div class="error-emoji">üò¢</div>
                        <div class="error-message">Brick ${cell} not found</div>
                        <p>This brick hasn't been claimed yet!</p>
                        <a href="buy-original.html?cell=${cell}" class="claim-button">üß± Claim this brick</a>
                    `;
                    return;
                }

                // Si c'est une brique Plaza, rediriger
                if (data.kind === 'plaza') {
                    window.location.href = `plaza-brick.html?cell=${cell}`;
                    return;
                }

                // Afficher la brique Canvas
                const walletShort = data.wallet ? `${data.wallet.slice(0,4)}...${data.wallet.slice(-4)}` : 'Unknown';
                
                document.getElementById('content').innerHTML = `
                    <img class="brick-image" src="${data.image_url || 'https://placehold.co/200x200/FF44AA/FFFFFF?text=üß±'}" 
                         onerror="this.src='https://placehold.co/200x200/FF44AA/FFFFFF?text=üß±'">
                    <div class="brick-cell">üß± ${data.cell}</div>
                    <div class="brick-message">"${data.message || 'No message'}"</div>
                    <div class="brick-wallet">${walletShort}</div>
                `;

            } catch (e) {
                console.error('Error:', e);
                document.getElementById('content').innerHTML = `
                    <div class="error-emoji">‚ö†Ô∏è</div>
                    <div class="error-message">Error loading brick</div>
                `;
            }
        }

        loadBrick();
    </script>

    <!-- ===== CAPTURE UNIVERSELLE DES R√âF√âRENTS ===== -->
    <script>
    (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const referrerWallet = urlParams.get('ref');
        
        if (referrerWallet) {
            localStorage.setItem('brick_referrer', referrerWallet);
            console.log('‚úÖ R√©f√©rent d√©tect√©:', referrerWallet.slice(0,4) + '...' + referrerWallet.slice(-4));
            
            const refMessage = document.createElement('div');
            refMessage.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #FF44AA; color: white; padding: 12px 24px; border-radius: 50px; font-size: 14px; z-index: 9999; box-shadow: 0 4px 20px rgba(255,68,170,0.4);';
            refMessage.innerHTML = `üß± Referred by ${referrerWallet.slice(0,4)}...${referrerWallet.slice(-4)}`;
            document.body.appendChild(refMessage);
            setTimeout(() => refMessage.remove(), 5000);
        }
    })();
    </script>
</body>
</html>
