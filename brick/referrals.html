<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß± BRICK - Referral Program</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß±</text></svg>">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
            min-height: 100vh;
            color: #1e293b;
        }

        /* ===== STICKY MENU ===== */
        .nav {
            background: white;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #FF44AA20;
            padding: 12px 24px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(255,68,170,0.1);
        }

        .nav-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 24px;
            font-weight: 800;
        }

        .brand a {
            text-decoration: none;
            color: #FF44AA;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .brand span {
            font-size: 28px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: #64748b;
            text-decoration: none;
            font-weight: 600;
            font-size: 15px;
            padding: 8px 16px;
            border-radius: 40px;
            transition: all 0.2s;
            background: transparent;
        }

        .nav-links a:hover {
            color: #FF44AA;
            background: #fff0f5;
        }

        .nav-links a.active {
            color: #FF44AA;
            background: #fff0f5;
            border: 1px solid #FF44AA20;
        }

        .spacer {
            flex: 1;
        }

        .wallet-badge {
            background: #fff0f5;
            border: 1px solid #FF44AA;
            padding: 6px 16px;
            border-radius: 40px;
            font-size: 13px;
            font-weight: 600;
            color: #FF44AA;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #whoamiNav {
            font-weight: 600;
            font-size: 13px;
        }

        .btn-connect {
            background: #FF44AA;
            border: none;
            padding: 8px 20px;
            border-radius: 40px;
            color: white;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
            box-shadow: 0 4px 10px rgba(255,68,170,0.3);
        }

        .btn-connect:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255,68,170,0.4);
        }

        /* ===== MAIN CONTAINER ===== */
        .wrap {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 24px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-header h1 {
            font-size: 48px;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 16px;
        }

        .page-header h1 span {
            font-size: 56px;
            animation: bounce 2s infinite ease-in-out;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .page-header p {
            font-size: 18px;
            color: #64748b;
            max-width: 600px;
            margin: 0 auto;
        }

        /* ===== GRID LAYOUT (exact same as before) ===== */
        .grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
        }

        @media (max-width: 1000px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        /* ===== CARDS (harmonized with BRICK style) ===== */
        .card {
            background: white;
            border-radius: 32px;
            padding: 28px;
            margin-bottom: 24px;
            border: 2px solid #FF44AA20;
            box-shadow: 0 10px 30px rgba(255,68,170,0.1);
            transition: all 0.3s;
        }

        .card:hover {
            border-color: #FF44AA;
            box-shadow: 0 20px 40px rgba(255,68,170,0.15);
        }

        .card-glow {
            border: 2px solid #FF44AA;
            box-shadow: 0 10px 30px rgba(255,68,170,0.2);
        }

        .title {
            font-size: 28px;
            font-weight: 800;
            color: #FF44AA;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .title-sm {
            font-size: 22px;
            margin-bottom: 16px;
        }

        /* ===== WALLET SECTION ===== */
        .connect-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .wallet-info {
            display: flex;
            align-items: center;
            gap: 16px;
            background: #fff0f5;
            padding: 16px 20px;
            border-radius: 24px;
            border: 1px solid #FF44AA;
        }

        .wallet-avatar {
            width: 48px;
            height: 48px;
            background: #FF44AA;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 24px;
            color: white;
        }

        .wallet-address {
            font-family: monospace;
            font-size: 16px;
            color: #FF44AA;
            font-weight: 600;
        }

        .ref-link-box {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .ref-link-box input {
            flex: 1;
            background: #f8fafc;
            border: 2px solid #FF44AA20;
            border-radius: 60px;
            padding: 14px 20px;
            color: #1e293b;
            font-family: monospace;
            font-size: 14px;
        }

        .ref-link-box input:focus {
            outline: none;
            border-color: #FF44AA;
        }

        .btn-copy {
            background: #fff0f5;
            border: 2px solid #FF44AA;
            border-radius: 60px;
            padding: 0 24px;
            color: #FF44AA;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-copy:hover {
            background: #FF44AA;
            color: white;
        }

        /* ===== DASHBOARD KPI ===== */
        .kpi-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: #f8fafc;
            border: 2px solid #FF44AA20;
            border-radius: 24px;
            padding: 20px;
        }

        .kpi-label {
            font-size: 14px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 36px;
            font-weight: 800;
            color: #FF44AA;
            line-height: 1;
        }

        .kpi-unit {
            font-size: 14px;
            color: #64748b;
            margin-left: 4px;
        }

        /* ===== ACTIVITY LIST ===== */
        .activity-list {
            background: #f8fafc;
            border-radius: 24px;
            padding: 16px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid #FF44AA20;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            background: #fff0f5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .activity-detail {
            flex: 1;
            font-size: 14px;
        }

        .activity-detail span {
            color: #FF44AA;
            font-weight: 600;
        }

        .activity-time {
            font-size: 12px;
            color: #94a3b8;
        }

        /* ===== PROMO KIT (simplified) ===== */
        .promo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin: 20px 0;
        }

        @media (max-width: 800px) {
            .promo-grid {
                grid-template-columns: 1fr;
            }
        }

        .promo-card {
            background: #f8fafc;
            border: 2px solid #FF44AA20;
            border-radius: 24px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .promo-card:hover {
            border-color: #FF44AA;
            transform: translateY(-5px);
        }

        .promo-preview {
            width: 100%;
            aspect-ratio: var(--ratio);
            background: linear-gradient(135deg, #FF44AA20, #B87CFF20);
            border-radius: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #FF44AA20;
            color: #FF44AA;
            font-weight: 600;
        }

        .promo-format {
            font-weight: 700;
            color: #FF44AA;
            margin-bottom: 12px;
        }

        .btn-download {
            background: white;
            border: 2px solid #FF44AA;
            border-radius: 60px;
            padding: 10px 20px;
            color: #FF44AA;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            font-family: 'Inter', sans-serif;
        }

        .btn-download:hover {
            background: #FF44AA;
            color: white;
        }

        /* ===== RULES SECTION ===== */
        .rules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }

        .rule-item {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            background: #f8fafc;
            padding: 16px;
            border-radius: 16px;
            border: 1px solid #FF44AA20;
        }

        .rule-check {
            color: #00aa88;
            font-size: 20px;
        }

        .rule-cross {
            color: #ff4466;
            font-size: 20px;
        }

        .rule-text {
            flex: 1;
        }

        .rule-title {
            font-weight: 700;
            color: #FF44AA;
        }

        .rule-desc {
            font-size: 13px;
            color: #64748b;
        }

        /* ===== FAQ ===== */
        .faq-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #FF44AA20;
        }

        .faq-item:last-child {
            border-bottom: none;
        }

        .faq-question {
            font-weight: 700;
            color: #FF44AA;
            margin-bottom: 6px;
            font-size: 16px;
        }

        .faq-answer {
            color: #64748b;
            font-size: 14px;
            line-height: 1.6;
        }

        /* ===== FOOTER ===== */
        .footer {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 2px solid #FF44AA20;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            flex-wrap: wrap;
            max-width: 1300px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .footer-links a {
            color: #64748b;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            transition: color 0.2s;
        }

        .footer-links a:hover {
            color: #FF44AA;
        }

        .footer-copyright {
            text-align: center;
            margin: 30px 0 20px;
            color: #94a3b8;
            font-size: 14px;
        }

        .text-center { text-align: center; }
        .mt-4 { margin-top: 16px; }
        .mb-2 { margin-bottom: 8px; }
    </style>
</head>
<body>

<!-- ===== STICKY MENU PROFESSIONNEL ===== -->
<div class="nav">
    <div class="nav-inner">
        <div class="brand">
            <a href="index.html">
                <span>üß±</span> BRICK
            </a>
        </div>
        
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="canvas.html">Canvas</a>
            <a href="plaza.html">Plaza</a>
            <a href="eternal-moments.html">Eternal</a>
            <a href="how-it-works.html">How it works</a>
            <a href="referrals.html" class="active">Referrals</a>
            <a href="daily.html">Daily</a>
        </div>
        
        <div class="spacer"></div>
        
        <div class="wallet-badge">
            <span>üîå</span>
            <span id="whoamiNav">Not connected</span>
        </div>
        
        <button class="btn-connect" onclick="connectWallet()" data-connect-wallet>
            Connect Wallet
        </button>
    </div>
</div>

<!-- ===== MAIN CONTENT ===== -->
<div class="wrap">
    
    <!-- Page Header -->
    <div class="page-header">
        <h1>
            <span>üß±</span> REFERRAL PROGRAM
        </h1>
        <p>
            Invite friends, earn commissions in $BRICK or USDC. Simple, transparent, automatic.
        </p>
    </div>

    <!-- Main Grid (exact same layout) -->
    <div class="grid">
        
        <!-- LEFT COLUMN: Connect + Link + Promo + Rules -->
        <div class="col-left">
            
            <!-- Connect Wallet Card -->
            <div class="card card-glow">
                <h2 class="title title-sm">1. Connect your wallet</h2>
                
                <div class="connect-section">
                    <div class="wallet-info" id="walletInfo" style="display: none;">
                        <div class="wallet-avatar" id="walletAvatar">üß±</div>
                        <div>
                            <div style="font-size: 12px; color: #64748b;">Connected wallet</div>
                            <div class="wallet-address" id="walletAddress">...</div>
                        </div>
                    </div>
                    
                    <div id="connectPrompt">
                        <p style="color: #64748b; margin-bottom: 16px;">
                            Connect your Solana wallet to generate your unique referral link.
                        </p>
                        <button class="btn-connect" onclick="connectWallet()" style="width: 100%;">
                            üîå Connect Wallet
                        </button>
                    </div>
                </div>
            </div>

            <!-- Referral Link Card -->
            <div class="card" id="referralCard" style="display: none;">
                <h2 class="title title-sm">2. Your unique link</h2>
                
                <div class="ref-link-box">
                    <input type="text" id="refLink" readonly value="Connect your wallet to generate your link" />
                    <button class="btn-copy" onclick="copyRefLink()" id="copyRefBtn">Copy</button>
                </div>
                
                <p style="color: #64748b; font-size: 14px; margin-top: 12px;">
                    üîó Share this link on Twitter, Telegram, Discord... Every click counts!
                </p>
            </div>

            <!-- Promo Kit Card (simplified) -->
            <div class="card">
                <h2 class="title title-sm">3. Promo kit (ready to use)</h2>
                <p style="color: #64748b; margin-bottom: 16px;">
                    3 optimized formats for social media. Download and post directly.
                </p>

                <div class="promo-grid">
                    <!-- Twitter -->
                    <div class="promo-card">
                        <div class="promo-preview" style="--ratio: 1200/675;">
                            <span>üê¶ Twitter/X</span>
                        </div>
                        <div class="promo-format">1200 √ó 675</div>
                        <button class="btn-download" onclick="downloadPromo('twitter')" id="dlTwitter">
                            ‚¨áÔ∏è Download
                        </button>
                    </div>

                    <!-- Telegram -->
                    <div class="promo-card">
                        <div class="promo-preview" style="--ratio: 1280/720;">
                            <span>‚úàÔ∏è Telegram</span>
                        </div>
                        <div class="promo-format">1280 √ó 720</div>
                        <button class="btn-download" onclick="downloadPromo('telegram')" id="dlTelegram">
                            ‚¨áÔ∏è Download
                        </button>
                    </div>

                    <!-- Story -->
                    <div class="promo-card">
                        <div class="promo-preview" style="--ratio: 1080/1920;">
                            <span>üì± Story / Reel</span>
                        </div>
                        <div class="promo-format">1080 √ó 1920</div>
                        <button class="btn-download" onclick="downloadPromo('story')" id="dlStory">
                            ‚¨áÔ∏è Download
                        </button>
                    </div>
                </div>

                <p style="color: #64748b; font-size: 13px; text-align: center; margin-top: 12px;">
                    ‚ö° Images automatically include your referral code when wallet is connected.
                </p>
            </div>

            <!-- Rules Card -->
            <div class="card">
                <h2 class="title title-sm">üìú Program Rules</h2>
                
                <div class="rules-grid">
                    <div class="rule-item">
                        <span class="rule-check">‚úÖ</span>
                        <div class="rule-text">
                            <div class="rule-title">15% on creations</div>
                            <div class="rule-desc">Commission on token creation fees</div>
                        </div>
                    </div>
                    
                    <div class="rule-item">
                        <span class="rule-check">‚úÖ</span>
                        <div class="rule-text">
                            <div class="rule-title">10% on liquidity</div>
                            <div class="rule-desc">Commission on liquidity addition fees</div>
                        </div>
                    </div>
                    
                    <div class="rule-item">
                        <span class="rule-check">‚úÖ</span>
                        <div class="rule-text">
                            <div class="rule-title">Choice of payment</div>
                            <div class="rule-desc">$BRICK or USDC, your choice</div>
                        </div>
                    </div>
                    
                    <div class="rule-item">
                        <span class="rule-check">‚úÖ</span>
                        <div class="rule-text">
                            <div class="rule-title">$25 threshold</div>
                            <div class="rule-desc">Automatic weekly payments</div>
                        </div>
                    </div>
                    
                    <div class="rule-item">
                        <span class="rule-cross">‚ùå</span>
                        <div class="rule-text">
                            <div class="rule-title">No self-referrals</div>
                            <div class="rule-desc">Automatic fraud detection</div>
                        </div>
                    </div>
                    
                    <div class="rule-item">
                        <span class="rule-check">‚úÖ</span>
                        <div class="rule-text">
                            <div class="rule-title">30 days</div>
                            <div class="rule-desc">Last click valid for 30 days</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Dashboard + FAQ -->
        <div class="col-right">
            
            <!-- Dashboard Card -->
            <div class="card card-glow">
                <h2 class="title title-sm">üìä My Dashboard</h2>
                
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">üí∞ Total earnings</div>
                        <div class="kpi-value" id="totalEarnings">0</div>
                        <div class="kpi-unit">USDC</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-label">üë• Active referrals</div>
                        <div class="kpi-value" id="activeReferrals">0</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-label">üîÑ Conversions</div>
                        <div class="kpi-value" id="totalConversions">0</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-label">‚è≥ Pending</div>
                        <div class="kpi-value" id="pendingEarnings">0</div>
                        <div class="kpi-unit">USDC</div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <h3 style="color: #FF44AA; margin: 20px 0 12px;">üìã Recent activity</h3>
                <div class="activity-list" id="activityList">
                    <div class="activity-item">
                        <div class="activity-icon">üîÑ</div>
                        <div class="activity-detail">
                            <span>0x3f...a2</span> purchased for 50 USDC
                        </div>
                        <div class="activity-time">just now</div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon">ü™ô</div>
                        <div class="activity-detail">
                            <span>0x7b...1c</span> created a token
                        </div>
                        <div class="activity-time">2h ago</div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon">üíß</div>
                        <div class="activity-detail">
                            <span>0x9d...4f</span> added liquidity
                        </div>
                        <div class="activity-time">5h ago</div>
                    </div>
                </div>
            </div>

            <!-- FAQ Card -->
            <div class="card">
                <h2 class="title title-sm">‚ùì Frequently Asked Questions</h2>
                
                <div class="faq-item">
                    <div class="faq-question">How am I rewarded?</div>
                    <div class="faq-answer">15% of token creation fees, 10% of liquidity fees. Payment in $BRICK or USDC weekly once your balance reaches $25.</div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question">How are referrals tracked?</div>
                    <div class="faq-answer">The ?ref= parameter in your link is stored locally. On first signed transaction, the referral is permanently linked to your wallet.</div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question">Can I refer myself?</div>
                    <div class="faq-answer">No, it's automatically detected and blocked. Circular referrals are also excluded.</div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question">Do links expire?</div>
                    <div class="faq-answer">Last click is valid for 30 days. If someone clicks then buys 3 weeks later, you still get rewarded.</div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question">Where can I see my earnings?</div>
                    <div class="faq-answer">Right here in this dashboard, in real-time once your wallet is connected.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-links">
            <a href="index.html">üß± Home</a>
            <a href="canvas.html">üé® Canvas</a>
            <a href="plaza.html">ü™ô Plaza</a>
            <a href="eternal-moments.html">‚ú® Eternal</a>
            <a href="how-it-works.html">üìö How it works</a>
            <a href="tokenomics.html">üìä Tokenomics</a>
            <a href="whitepaper.html">üìÑ Whitepaper</a>
            <a href="rules.html">‚öñÔ∏è Rules</a>
            <a href="daily.html">üìÖ Daily</a>
            <a href="https://x.com/TokenForgeApp" target="_blank">üê¶ Twitter</a>
            <a href="https://t.me/brick_fusion_news" target="_blank">üì¢ News</a>
            <a href="https://t.me/brick_community" target="_blank">üí¨ Chat</a>
            <a href="mailto:foundrix@protonmail.com">üìß Email</a>
        </div>
        <div class="footer-copyright">
            üß± BRICK ¬∑ Powered by TokenForge ¬∑ Built on Solana ¬∑ 2026
        </div>
    </footer>
</div>

<!-- Scripts (exact same functionality, just translated) -->
<script>
    // Configuration
    const SUPABASE_URL = "https://oqxfpcexrqniswghoowb.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xeGZwY2V4cnFuaXN3Z2hvb3diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4ODI4NTIsImV4cCI6MjA3MTQ1ODg1Mn0.BIXDRMHANGqf5hSKiqq-x0wIOSlW38ER_h_2CBpr8II";
    
    let sb = null;
    let currentUser = null;

    // Initialize Supabase
    (async () => {
        try {
            const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
            sb = createClient(SUPABASE_URL, SUPABASE_ANON);
        } catch (e) {
            console.warn('Supabase fallback mode');
            sb = { from: () => ({ select: () => Promise.resolve({ data: [] }) }) };
        }
    })();

    // DOM Elements
    const whoamiNav = document.getElementById('whoamiNav');
    const connectPrompt = document.getElementById('connectPrompt');
    const walletInfo = document.getElementById('walletInfo');
    const walletAddress = document.getElementById('walletAddress');
    const referralCard = document.getElementById('referralCard');
    const refLink = document.getElementById('refLink');
    const copyRefBtn = document.getElementById('copyRefBtn');

    // Stats elements
    const totalEarnings = document.getElementById('totalEarnings');
    const activeReferrals = document.getElementById('activeReferrals');
    const totalConversions = document.getElementById('totalConversions');
    const pendingEarnings = document.getElementById('pendingEarnings');
    const activityList = document.getElementById('activityList');

    // Connect Wallet Function
    window.connectWallet = async function() {
        try {
            // Detect Phantom or Solflare
            const provider = window.phantom?.solana || window.solflare;
            
            if (!provider) {
                alert('Install Phantom or Solflare to continue!');
                window.open('https://phantom.app/', '_blank');
                return;
            }

            // Connect
            const resp = await provider.connect();
            const publicKey = provider.publicKey?.toString() || resp.publicKey?.toString();
            
            if (!publicKey) throw new Error('No public key');

            // Update UI
            currentUser = publicKey;
            
            whoamiNav.textContent = `Connected: ${publicKey.slice(0,4)}...${publicKey.slice(-4)}`;
            whoamiNav.style.color = '#FF44AA';
            
            connectPrompt.style.display = 'none';
            walletInfo.style.display = 'flex';
            walletAddress.textContent = `${publicKey.slice(0,4)}...${publicKey.slice(-4)}`;
            
            // Generate referral link
            const baseUrl = window.location.origin;
            refLink.value = `${baseUrl}/?ref=${publicKey}`;
            referralCard.style.display = 'block';
            
            // Save to Supabase
            if (sb) {
                await sb.from('referral_links').upsert({
                    code: publicKey,
                    referrer_wallet: publicKey
                }, { onConflict: 'code' });
            }
            
            // Load stats
            await loadStats(publicKey);
            
        } catch (e) {
            console.error(e);
            alert('Connection error: ' + e.message);
        }
    };

    // Copy referral link
    window.copyRefLink = function() {
        if (!refLink.value || refLink.value.includes('Connect')) {
            alert('Connect your wallet first!');
            return;
        }
        
        navigator.clipboard.writeText(refLink.value);
        copyRefBtn.textContent = 'Copied!';
        setTimeout(() => { copyRefBtn.textContent = 'Copy'; }, 2000);
    };

    // Load stats from Supabase
    async function loadStats(wallet) {
        if (!sb) return;
        
        try {
            // Get conversions count and earnings
            const { data: conversions } = await sb
                .from('referral_conversions')
                .select('*')
                .eq('referrer_wallet', wallet);
            
            const { data: rewards } = await sb
                .from('referral_rewards')
                .select('*')
                .eq('referrer_wallet', wallet);
            
            // Calculate stats
            const convCount = conversions?.length || 0;
            const uniqueReferrals = new Set(conversions?.map(c => c.referee_wallet) || []).size;
            
            const pendingTotal = rewards
                ?.filter(r => r.status === 'pending')
                .reduce((sum, r) => sum + (r.amount_usdc || 0), 0) || 0;
            
            const paidTotal = rewards
                ?.filter(r => r.status === 'paid')
                .reduce((sum, r) => sum + (r.amount_usdc || 0), 0) || 0;
            
            // Update UI
            totalEarnings.textContent = (paidTotal + pendingTotal).toFixed(2);
            activeReferrals.textContent = uniqueReferrals;
            totalConversions.textContent = convCount;
            pendingEarnings.textContent = pendingTotal.toFixed(2);
            
            // Update activity list
            if (conversions?.length > 0) {
                const recent = conversions.slice(0, 5);
                activityList.innerHTML = recent.map(c => {
                    const timeAgo = c.ts ? new Date(c.ts).toLocaleString() : 'recently';
                    const shortWallet = c.referee_wallet?.slice(0,4) + '...' + c.referee_wallet?.slice(-4) || 'Unknown';
                    
                    return `
                        <div class="activity-item">
                            <div class="activity-icon">${c.kind === 'token' ? 'ü™ô' : c.kind === 'liquidity' ? 'üíß' : 'üîÑ'}</div>
                            <div class="activity-detail">
                                <span>${shortWallet}</span> ${c.kind === 'token' ? 'created a token' : c.kind === 'liquidity' ? 'added liquidity' : 'purchased'}
                            </div>
                            <div class="activity-time">${timeAgo}</div>
                        </div>
                    `;
                }).join('');
            }
            
        } catch (e) {
            console.warn('Stats error:', e);
        }
    }

    // Download promo images
    window.downloadPromo = async function(format) {
        if (!currentUser) {
            alert('Connect your wallet to generate images with your code!');
            return;
        }
        
        // Show loading
        const btn = document.getElementById(`dl${format.charAt(0).toUpperCase() + format.slice(1)}`);
        const originalText = btn.textContent;
        btn.textContent = '‚è≥ Generating...';
        btn.disabled = true;
        
        try {
            // Create temporary canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Dimensions based on format
            let width, height;
            if (format === 'twitter') { width = 1200; height = 675; }
            else if (format === 'telegram') { width = 1280; height = 720; }
            else { width = 1080; height = 1920; }
            
            canvas.width = width;
            canvas.height = height;
            
            // Draw background gradient
            const gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, '#FF44AA');
            gradient.addColorStop(0.5, '#B87CFF');
            gradient.addColorStop(1, '#9F5BFF');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);
            
            // Add brick pattern overlay
            ctx.fillStyle = 'rgba(255,255,255,0.05)';
            const brickW = 60;
            const brickH = 20;
            for (let y = 0; y < height; y += brickH * 2) {
                for (let x = 0; x < width; x += brickW * 2) {
                    ctx.fillRect(x, y, brickW, brickH);
                    ctx.fillRect(x + brickW, y + brickH, brickW, brickH);
                }
            }
            
            // Main text
            ctx.font = 'bold 80px "Inter", sans-serif';
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.fillText('üß± BRICK', width/2, height/2 - 60);
            
            ctx.font = 'bold 40px "Inter", sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,0.95)';
            ctx.fillText('Join the revolution', width/2, height/2 + 20);
            
            ctx.font = 'bold 30px "Inter", sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            
            const shortCode = currentUser.slice(0, 6) + '...' + currentUser.slice(-4);
            ctx.fillText(`Code: ${shortCode}`, width/2, height/2 + 80);
            
            // Footer
            ctx.font = '25px "Inter", sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,0.7)';
            ctx.fillText('tokenforge.live/brick', width/2, height - 60);
            
            // Download
            const link = document.createElement('a');
            link.download = `brick_${format}_${currentUser.slice(0,4)}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            
        } catch (e) {
            console.error(e);
            alert('Generation error');
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    };

    // Auto-refresh stats every 30 seconds
    setInterval(() => {
        if (currentUser) loadStats(currentUser);
    }, 30000);

    // Check for existing session
    window.addEventListener('load', async () => {
        const provider = window.phantom?.solana || window.solflare;
        if (provider?.isConnected && provider.publicKey) {
            const pubkey = provider.publicKey.toString();
            currentUser = pubkey;
            whoamiNav.textContent = `Connected: ${pubkey.slice(0,4)}...${pubkey.slice(-4)}`;
            whoamiNav.style.color = '#FF44AA';
            connectPrompt.style.display = 'none';
            walletInfo.style.display = 'flex';
            walletAddress.textContent = `${pubkey.slice(0,4)}...${pubkey.slice(-4)}`;
            refLink.value = `${window.location.origin}/?ref=${pubkey}`;
            referralCard.style.display = 'block';
            await loadStats(pubkey);
        }
    });
</script>

</body>
</html>